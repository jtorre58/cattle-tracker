<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🐄 Sistema de Gestión Ganadera</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="aws-sdk.min.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div id="app">
        <!-- Loading Indicator -->
        <div v-if="loading" class="loading-overlay">
            <div class="loading-spinner">
                <div class="spinner"></div>
                <p>Guardando datos...</p>
            </div>
        </div>
        
        <!-- User Selection Screen -->
        <div v-if="showUserSelection" class="user-selection-screen">
            <div class="user-selection-container">
                <div class="user-selection-header">
                    <h1>🐄 Sistema de Gestión Ganadera</h1>
                    <p>Selecciona tu usuario para continuar</p>
                </div>
                
                <div class="user-list">
                    <h3>👥 Usuarios Existentes</h3>
                    <div class="users-grid">
                        <div v-for="user in users" :key="user.id" class="user-card" @click="selectUser(user.id)">
                            <div class="user-avatar">{{ user.name.charAt(0).toUpperCase() }}</div>
                            <div class="user-info">
                                <h4>{{ user.name }}</h4>
                                <p>Creado: {{ new Date(user.createdAt).toLocaleDateString('es-ES') }}</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="create-user">
                    <h3>➕ Crear Nuevo Usuario</h3>
                    <div class="create-user-form">
                        <input 
                            type="text" 
                            v-model="newUserName" 
                            placeholder="Nombre del nuevo usuario..." 
                            class="user-input"
                            @keyup.enter="createNewUser"
                        >
                        <button @click="createNewUser" class="btn-create-user">Crear Usuario</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Application (only show when user is selected) -->
        <div v-if="!showUserSelection && currentUser" class="main-app">
        <!-- Header -->
        <header class="modern-header">
            <div class="header-container">
                <div class="brand">
                    <h1>🐄 Sistema de Gestión Ganadera</h1>
                    <div class="user-indicator">
                        <span class="current-user">👤 {{ currentUser.name }}</span>
                        <button @click="logoutUser" class="logout-btn" title="Cambiar Usuario">🚪</button>
                    </div>
                </div>
                <nav class="main-nav">
                    <button @click="activeTab = 'pariciones'" :class="{ active: activeTab === 'pariciones' }" class="nav-btn">
                        🍼 Pariciones
                    </button>
                    <button @click="activeTab = 'ganado'" :class="{ active: activeTab === 'ganado' }" class="nav-btn">
                        🐮 Inventario
                    </button>
                    <button @click="showHelp = true" class="nav-btn help-btn" title="Ayuda y Documentación">
                        ❓ Ayuda
                    </button>
                </nav>
            </div>
        </header>

        <!-- Main Layout -->
        <div class="app-layout">
            <!-- Sidebar -->
            <aside class="sidebar">
                <!-- Quick Actions -->
                <div class="sidebar-section">
                    <h3>⚡ Acciones Rápidas</h3>
                    <div class="quick-actions">
                        <button v-if="activeTab === 'pariciones'" @click="startAddParicion" class="action-btn primary">
                            ➕ Nueva Parición
                        </button>
                        <button v-if="activeTab === 'ganado'" @click="startAddGanado" class="action-btn primary">
                            ➕ Nuevo Ganado
                        </button>
                    </div>
                </div>

                <!-- Import Section -->
                <div class="sidebar-section">
                    <h3>📥 Importar Datos</h3>
                    <div class="import-actions">
                        <button v-if="activeTab === 'pariciones'" @click="showSpreadsheetImport = true" class="action-btn secondary">
                            📋 Desde Hoja
                        </button>
                        <button v-if="activeTab === 'pariciones'" @click="showCsvUpload = true" class="action-btn secondary">
                            📄 Archivo CSV
                        </button>
                        <button v-if="activeTab === 'ganado'" @click="showGanadoImport = true" class="action-btn secondary">
                            📋 Datos Ganado
                        </button>
                        <button @click="showSnapshotManager = true" class="action-btn info">
                            💾 Respaldos
                        </button>
                    </div>
                </div>

                <!-- Data Management -->
                <div class="sidebar-section">
                    <h3>💾 Gestión</h3>
                    <div class="management-actions">
                        <button @click="$refs.importFile.click()" class="action-btn info">
                            📥 Importar Respaldo
                        </button>
                        <button @click="exportData" class="action-btn info">
                            📤 Exportar Respaldo
                        </button>
                        <button @click="clearAllData" class="action-btn danger">
                            🗑️ Limpiar Datos
                        </button>
                    </div>
                    <input type="file" ref="importFile" @change="importData" accept=".json" style="display: none;">
                </div>
            </aside>

            <!-- Main Content -->
            <main class="main-content">
                <!-- Stats Dashboard -->
                <section class="stats-dashboard">
                    <div class="stats-grid">
                        <template v-if="activeTab === 'pariciones'">
                            <div class="stat-card primary">
                                <div class="stat-header">
                                    <span class="stat-icon">📊</span>
                                    <h3>Total Pariciones</h3>
                                </div>
                                <div class="stat-value">{{ totalFilteredPariciones }}</div>
                            </div>
                            <div class="stat-card success">
                                <div class="stat-header">
                                    <span class="stat-icon">♀️</span>
                                    <h3>Hembras</h3>
                                </div>
                                <div class="stat-value">{{ paricionesHembras }}</div>
                            </div>
                            <div class="stat-card info">
                                <div class="stat-header">
                                    <span class="stat-icon">♂️</span>
                                    <h3>Machos</h3>
                                </div>
                                <div class="stat-value">{{ paricionesMales }}</div>
                            </div>
                        </template>
                        
                        <template v-if="activeTab === 'ganado'">
                            <div class="stat-card primary">
                                <div class="stat-header">
                                    <span class="stat-icon">📈</span>
                                    <h3>Total Histórico</h3>
                                </div>
                                <div class="stat-value">{{ ganadoTotalHistorico }}</div>
                            </div>
                            <div class="stat-card success">
                                <div class="stat-header">
                                    <span class="stat-icon">🐄</span>
                                    <h3>Ganado Vivo</h3>
                                </div>
                                <div class="stat-value">{{ ganadoTotalNeto }}</div>
                            </div>
                            <div class="stat-card warning">
                                <div class="stat-header">
                                    <span class="stat-icon">♀️</span>
                                    <h3>Hembras</h3>
                                </div>
                                <div class="stat-value">{{ ganadoHembrasTotal }}</div>
                            </div>
                            <div class="stat-card info">
                                <div class="stat-header">
                                    <span class="stat-icon">♂️</span>
                                    <h3>Machos</h3>
                                </div>
                                <div class="stat-value">{{ ganadoMachosTotal }}</div>
                            </div>
                            <div class="stat-card primary">
                                <div class="stat-header">
                                    <span class="stat-icon">💀</span>
                                    <h3>Muertos/Vendidos</h3>
                                </div>
                                <div class="stat-value">{{ ganadoMuertosVendidos }}</div>
                            </div>
                        </template>
                    </div>
                </section>

                <!-- Filters Section -->
                <section v-if="activeTab === 'pariciones'" class="filters-section">
                    <div class="filters-container">
                        <h3>🔍 Filtros</h3>
                        <div class="filters-grid">
                            <div class="filter-group">
                                <label>Año:</label>
                                <select v-model="yearFilter" class="filter-select">
                                    <option value="all">Todos los Años</option>
                                    <option v-for="year in availableYears" :key="year" :value="year">{{ year }}</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label>Mes:</label>
                                <select v-model="monthFilter" class="filter-select">
                                    <option value="all">Todos los Meses</option>
                                    <option value="1">Enero</option>
                                    <option value="2">Febrero</option>
                                    <option value="3">Marzo</option>
                                    <option value="4">Abril</option>
                                    <option value="5">Mayo</option>
                                    <option value="6">Junio</option>
                                    <option value="7">Julio</option>
                                    <option value="8">Agosto</option>
                                    <option value="9">Septiembre</option>
                                    <option value="10">Octubre</option>
                                    <option value="11">Noviembre</option>
                                    <option value="12">Diciembre</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label>Desde:</label>
                                <input type="date" v-model="dateFrom" class="filter-input">
                            </div>
                            <div class="filter-group">
                                <label>Hasta:</label>
                                <input type="date" v-model="dateTo" class="filter-input">
                            </div>
                            <div class="filter-group">
                                <button @click="clearFilters" class="clear-filters-btn">🗑️ Limpiar</button>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Data Table Section -->
                <section class="data-section">
                    <!-- Pariciones Table -->
                    <div v-if="activeTab === 'pariciones'" class="data-table-container">
                        <h3>📋 Registro de Pariciones</h3>
                        <div class="table-wrapper">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Vaca</th>
                                        <th>Arete</th>
                                        <th>Género</th>
                                        <th>Fecha</th>
                                        <th>Cría Descripción</th>
                                        <th>Foto</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-for="paricion in filteredPariciones" :key="paricion.id" class="table-row">
                                        <td class="cell-vaca">{{ paricion.vaca }}</td>
                                        <td class="cell-arete">{{ paricion.arete || '-' }}</td>
                                        <td class="cell-gender">
                                            <span :class="['gender-badge', paricion.gender.toUpperCase() === 'H' ? 'female' : 'male']">
                                                {{ paricion.gender.toUpperCase() === 'H' ? '♀️ H' : '♂️ M' }}
                                            </span>
                                        </td>
                                        <td class="cell-date">{{ paricion.fecha }}</td>
                                        <td class="cell-notes">{{ paricion.criaDescripcion || '-' }}</td>
                                        <td class="cell-image">
                                            <img v-if="paricion.image || paricion.imageUrl" :src="paricion.image || paricion.imageUrl" alt="Foto" class="table-image" @click="openImageLightbox(paricion.image || paricion.imageUrl)">
                                            <span v-else class="no-image">📷</span>
                                        </td>
                                        <td class="cell-actions">
                                            <button @click="editParicion(paricion)" class="edit-btn">✏️</button>
                                            <button @click="showFamilyTreeFor(paricion)" class="family-btn">🌳</button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Ganado Table -->
                    <div v-if="activeTab === 'ganado'" class="data-table-container ganado-container">
                        <h3>📋 Inventario de Ganado</h3>
                        <div class="filters-bar">
                            <div class="filter-row">
                                <select v-model="ganadoFilter" class="filter-select">
                                    <option value="all">Todos los Tipos</option>
                                    <option value="V">🐄 Vacas</option>
                                    <option value="T">🐂 Toros</option>
                                    <option value="B">🐄 Becerras</option>
                                    <option value="_B">🐂 Becerros</option>
                                </select>
                                
                                <select v-model="ganadoStatusFilter" class="filter-select">
                                    <option value="all">Todos los Estados</option>
                                    <option value="alive">✅ Vivos</option>
                                    <option value="dead">💀 Muertos/Vendidos</option>
                                </select>
                                
                                <select v-model="ganadoGenderFilter" class="filter-select">
                                    <option value="all">Todos los Géneros</option>
                                    <option value="H">♀️ Hembras</option>
                                    <option value="M">♂️ Machos</option>
                                </select>
                                
                                <select v-model="ganadoOrigenFilter" class="filter-select">
                                    <option value="">Todos los Orígenes</option>
                                    <option v-for="origen in uniqueOrigenes" :key="origen" :value="origen">
                                        {{ origen }}
                                    </option>
                                </select>
                            </div>
                            
                            <div class="filter-row">
                                <input 
                                    type="text" 
                                    v-model="ganadoDateFilter" 
                                    placeholder="Filtrar por fecha..." 
                                    class="filter-input"
                                >
                                
                                <input 
                                    type="text" 
                                    v-model="ganadoCommentFilter" 
                                    placeholder="Filtrar por comentarios..." 
                                    class="filter-input"
                                >
                                
                                <button @click="clearGanadoFilters" class="btn-clear-filters">
                                    🗑️ Limpiar Filtros
                                </button>
                            </div>
                            
                            <div class="filter-results">
                                Mostrando {{ filteredGanado.length }} de {{ ganado.length }} registros
                            </div>
                        </div>
                        <div class="table-wrapper">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Animal</th>
                                        <th>Tipo</th>
                                        <th>Género</th>
                                        <th>Estado</th>
                                        <th>Origen</th>
                                        <th>Comentarios</th>
                                        <th>Fechas</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-for="ganado in filteredGanado" :key="ganado.id" class="table-row">
                                        <td class="cell-animal">{{ ganado.animal }}</td>
                                        <td class="cell-type">
                                            <span :class="['type-badge', 'type-' + ganado.tipo]">
                                                {{ ganado.tipo === 'V' ? '🐄 Vaca' : ganado.tipo === 'T' ? '🐂 Toro' : ganado.tipo === 'B' ? '🐄 Becerra' : '🐂 Becerro' }}
                                            </span>
                                        </td>
                                        <td class="cell-gender">
                                            <span :class="['gender-badge', ganado.gender === 'H' ? 'female' : 'male']">
                                                {{ ganado.gender === 'H' ? '♀️ H' : '♂️ M' }}
                                            </span>
                                        </td>
                                        <td class="cell-status">
                                            <span :class="['status-badge', ganado.muerto_vendido === 'S' ? 'dead' : 'alive']">
                                                {{ ganado.muerto_vendido === 'S' ? '💀 Muerto/Vendido' : '✅ Vivo' }}
                                            </span>
                                        </td>
                                        <td class="cell-origin">{{ ganado.origen || '-' }}</td>
                                        <td class="cell-comments">{{ ganado.comentarios || '-' }}</td>
                                        <td class="cell-dates">{{ ganado.fechas || '-' }}</td>
                                        <td class="cell-actions">
                                            <button @click="editGanadoRecord(ganado)" class="edit-btn">✏️</button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>
            </main>
        </div>

        <!-- Help Modal -->
        <div v-if="showHelp" class="modal-overlay" @click.self="showHelp = false">
            <div class="modal-content help-modal">
                <div class="modal-header">
                    <h2>❓ Ayuda y Documentación</h2>
                    <button @click="showHelp = false" class="modal-close">×</button>
                </div>
                
                <div class="help-content">
                    <div class="help-nav">
                        <button @click="helpSection = 'overview'" :class="{ active: helpSection === 'overview' }" class="help-nav-btn">
                            📋 Resumen
                        </button>
                        <button @click="helpSection = 'pariciones'" :class="{ active: helpSection === 'pariciones' }" class="help-nav-btn">
                            🍼 Pariciones
                        </button>
                        <button @click="helpSection = 'inventario'" :class="{ active: helpSection === 'inventario' }" class="help-nav-btn">
                            🐮 Inventario
                        </button>
                        <button @click="helpSection = 'import'" :class="{ active: helpSection === 'import' }" class="help-nav-btn">
                            📥 Importar
                        </button>
                        <button @click="helpSection = 'backup'" :class="{ active: helpSection === 'backup' }" class="help-nav-btn">
                            💾 Respaldos
                        </button>
                    </div>
                    
                    <div class="help-body">
                        <!-- Overview Section -->
                        <div v-if="helpSection === 'overview'" class="help-section">
                            <h3>📋 Resumen del Sistema</h3>
                            <p>El Sistema de Gestión Ganadera te permite llevar un control completo de tu ganado y pariciones.</p>
                            
                            <h4>🎯 Funciones Principales:</h4>
                            <ul>
                                <li><strong>🍼 Pariciones:</strong> Registra nacimientos y seguimiento de crías</li>
                                <li><strong>🐮 Inventario:</strong> Control completo del ganado (vivos/muertos/vendidos)</li>
                                <li><strong>📥 Importación:</strong> Desde CSV o hojas de cálculo</li>
                                <li><strong>💾 Respaldos:</strong> Crea y restaura snapshots de tus datos</li>
                                <li><strong>🔍 Filtros:</strong> Búsqueda avanzada por múltiples criterios</li>
                                <li><strong>📊 Estadísticas:</strong> Contadores automáticos en tiempo real</li>
                            </ul>
                            
                            <h4>🚀 Inicio Rápido:</h4>
                            <ol>
                                <li>Usa las pestañas <strong>🍼 Pariciones</strong> y <strong>🐮 Inventario</strong> para navegar</li>
                                <li>Click <strong>➕ Nueva Parición</strong> o <strong>➕ Nuevo Ganado</strong> para agregar registros</li>
                                <li>Usa los filtros para encontrar información específica</li>
                                <li>Crea respaldos regulares con <strong>💾 Respaldos</strong></li>
                            </ol>
                        </div>
                        
                        <!-- Pariciones Section -->
                        <div v-if="helpSection === 'pariciones'" class="help-section">
                            <h3>🍼 Gestión de Pariciones</h3>
                            <p>Registra y gestiona todos los nacimientos de tu ganado.</p>
                            
                            <h4>➕ Agregar Nueva Parición:</h4>
                            <ol>
                                <li>Click en <strong>➕ Nueva Parición</strong></li>
                                <li>Completa los campos:
                                    <ul>
                                        <li><strong>Vaca:</strong> Nombre de la madre</li>
                                        <li><strong>Género:</strong> H (Hembra) o M (Macho)</li>
                                        <li><strong>Fecha:</strong> MM/YY o MM/DD/YYYY</li>
                                        <li><strong>Cría Descripción:</strong> Detalles del nacimiento</li>
                                        <li><strong>Foto:</strong> Imagen opcional</li>
                                    </ul>
                                </li>
                                <li>Click <strong>➕ Agregar Parición</strong></li>
                            </ol>
                            
                            <h4>🔍 Filtros Disponibles:</h4>
                            <ul>
                                <li><strong>Por año:</strong> Selecciona año específico</li>
                                <li><strong>Por mes:</strong> Enero a Diciembre</li>
                                <li><strong>Por género:</strong> Hembras, Machos, o Todos</li>
                                <li><strong>Por fechas:</strong> Rango de fechas</li>
                                <li><strong>Por vaca:</strong> Buscar por nombre de madre</li>
                            </ul>
                            
                            <h4>✏️ Editar Pariciones:</h4>
                            <p>Click en el botón <strong>✏️</strong> en cualquier fila para editar el registro.</p>
                        </div>
                        
                        <!-- Inventario Section -->
                        <div v-if="helpSection === 'inventario'" class="help-section">
                            <h3>🐮 Inventario de Ganado</h3>
                            <p>Control completo de tu inventario ganadero con estados y clasificaciones.</p>
                            
                            <h4>➕ Agregar Nuevo Ganado:</h4>
                            <ol>
                                <li>Click en <strong>➕ Nuevo Ganado</strong></li>
                                <li>Completa los campos:
                                    <ul>
                                        <li><strong>Animal:</strong> Nombre del animal</li>
                                        <li><strong>Tipo:</strong> Vaca, Toro, Becerra, Becerro</li>
                                        <li><strong>Género:</strong> Hembra o Macho</li>
                                        <li><strong>Estado:</strong> Vivo o Muerto/Vendido</li>
                                        <li><strong>Origen:</strong> De dónde proviene</li>
                                        <li><strong>Comentarios:</strong> Notas adicionales</li>
                                        <li><strong>Fechas:</strong> Fechas importantes</li>
                                    </ul>
                                </li>
                                <li>Click <strong>➕ Agregar Ganado</strong></li>
                            </ol>
                            
                            <h4>🔍 Filtros Avanzados:</h4>
                            <ul>
                                <li><strong>Tipo:</strong> Vacas, Toros, Becerras, Becerros</li>
                                <li><strong>Estado:</strong> Vivos, Muertos/Vendidos</li>
                                <li><strong>Género:</strong> Hembras, Machos</li>
                                <li><strong>Origen:</strong> Selecciona de lista de orígenes</li>
                                <li><strong>Fechas:</strong> Busca texto en fechas</li>
                                <li><strong>Comentarios:</strong> Busca texto en comentarios</li>
                            </ul>
                            
                            <p><strong>💡 Tip:</strong> Usa <strong>🗑️ Limpiar Filtros</strong> para resetear todos los filtros.</p>
                        </div>
                        
                        <!-- Import Section -->
                        <div v-if="helpSection === 'import'" class="help-section">
                            <h3>📥 Importación de Datos</h3>
                            <p>Importa datos desde CSV o hojas de cálculo de Excel/Google Sheets.</p>
                            
                            <h4>📋 Desde Hoja de Cálculo:</h4>
                            <ol>
                                <li>Prepara tus datos en Excel/Google Sheets</li>
                                <li>Selecciona y copia los datos (incluyendo encabezados)</li>
                                <li>Click <strong>📋 Desde Hoja</strong></li>
                                <li>Pega los datos en el área de texto</li>
                                <li>Click <strong>📊 Procesar Datos</strong></li>
                                <li>Revisa la vista previa y duplicados</li>
                                <li>Click <strong>✅ Importar</strong></li>
                            </ol>
                            
                            <h4>📄 Formato para Pariciones (4 columnas):</h4>
                            <pre>Vaca, Género, Fecha, Cría Descripción
Gorrita, H, 08/23, Becerra saludable
Mora, M, 09/23, Becerro grande</pre>
                            
                            <h4>📄 Formato para Ganado (7 columnas):</h4>
                            <pre>Animal, Origen, Comentarios, Género, Tipo, Fechas, Estado
Becerra1, Rancho Norte, Animal joven, H, B, 01/2023, N
Toro1, Compra, Reproductor, M, T, 12/2022, N</pre>
                            
                            <h4>⚠️ Detección de Duplicados:</h4>
                            <p>El sistema detecta automáticamente duplicados y te muestra una comparación antes de importar.</p>
                        </div>
                        
                        <!-- Backup Section -->
                        <div v-if="helpSection === 'backup'" class="help-section">
                            <h3>💾 Sistema de Respaldos</h3>
                            <p>Crea y gestiona snapshots de tus datos para protección y migración.</p>
                            
                            <h4>💾 Crear Respaldo:</h4>
                            <ol>
                                <li>Click en <strong>💾 Respaldos</strong></li>
                                <li>Ingresa un nombre descriptivo</li>
                                <li>Selecciona el tipo:
                                    <ul>
                                        <li><strong>💾 Completo:</strong> Pariciones + Inventario</li>
                                        <li><strong>🍼 Solo Pariciones:</strong> Solo nacimientos</li>
                                        <li><strong>🐮 Solo Inventario:</strong> Solo ganado</li>
                                    </ul>
                                </li>
                                <li>El respaldo se guarda automáticamente</li>
                            </ol>
                            
                            <h4>📥 Cargar Respaldo:</h4>
                            <ol>
                                <li>En la lista de respaldos, encuentra el deseado</li>
                                <li>Click <strong>📥 Cargar</strong></li>
                                <li>Confirma la acción (reemplazará datos actuales)</li>
                                <li>Los datos se restauran automáticamente</li>
                            </ol>
                            
                            <h4>⬇️ Descargar Respaldo:</h4>
                            <p>Click <strong>⬇️ Descargar</strong> para obtener un archivo JSON que puedes usar para transferir datos entre sistemas.</p>
                            
                            <h4>💡 Mejores Prácticas:</h4>
                            <ul>
                                <li>Crea respaldos antes de importaciones grandes</li>
                                <li>Usa nombres descriptivos con fechas</li>
                                <li>Descarga respaldos importantes externamente</li>
                                <li>Elimina respaldos obsoletos regularmente</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Snapshot Manager Modal -->
        <div v-if="showSnapshotManager" class="modal-overlay" @click.self="showSnapshotManager = false">
            <div class="modal-content snapshot-modal">
                <div class="modal-header">
                    <h2>💾 Gestión de Respaldos</h2>
                    <button @click="showSnapshotManager = false" class="modal-close">×</button>
                </div>
                
                <!-- Create New Snapshot -->
                <div class="snapshot-create">
                    <h3>Crear Nuevo Respaldo</h3>
                    <div class="form-row">
                        <input 
                            type="text" 
                            v-model="snapshotName" 
                            placeholder="Nombre del respaldo..." 
                            class="form-input"
                            @keyup.enter="saveSnapshot('full')"
                        >
                        <button @click="saveSnapshot('full')" class="btn-primary">💾 Completo</button>
                        <button @click="saveSnapshot('pariciones')" class="btn-secondary">🍼 Solo Pariciones</button>
                        <button @click="saveSnapshot('ganado')" class="btn-secondary">🐮 Solo Inventario</button>
                    </div>
                </div>
                
                <!-- Saved Snapshots List -->
                <div class="snapshots-list">
                    <h3>Respaldos Guardados ({{ savedSnapshots.length }})</h3>
                    <div v-if="savedSnapshots.length === 0" class="no-snapshots">
                        No hay respaldos guardados
                    </div>
                    <div v-else class="snapshots-grid">
                        <div v-for="snapshot in savedSnapshots" :key="snapshot.id" class="snapshot-card">
                            <div class="snapshot-header">
                                <h4>{{ snapshot.name }}</h4>
                                <span class="snapshot-type" :class="'type-' + snapshot.type">
                                    {{ snapshot.type === 'full' ? '💾 Completo' : 
                                       snapshot.type === 'pariciones' ? '🍼 Pariciones' : '🐮 Inventario' }}
                                </span>
                            </div>
                            <div class="snapshot-info">
                                <p><strong>Fecha:</strong> {{ snapshot.date }}</p>
                                <p v-if="snapshot.data.pariciones"><strong>Pariciones:</strong> {{ snapshot.data.pariciones.length }}</p>
                                <p v-if="snapshot.data.ganado"><strong>Ganado:</strong> {{ snapshot.data.ganado.length }}</p>
                            </div>
                            <div class="snapshot-actions">
                                <button @click="loadSnapshot(snapshot.id)" class="btn-load">📥 Cargar</button>
                                <button @click="downloadSnapshot(snapshot.id)" class="btn-download">⬇️ Descargar</button>
                                <button @click="deleteSnapshot(snapshot.id)" class="btn-delete">🗑️ Eliminar</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modals -->
        <!-- Add/Edit Paricion Modal -->
        <div v-if="showAddParicion" class="modal-overlay" @click.self="showAddParicion = false">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>{{ editingParicion ? '✏️ Editar' : '➕ Agregar' }} Parición</h2>
                    <button @click="showAddParicion = false" class="modal-close">×</button>
                </div>
                <form @submit.prevent="saveParicion" class="modal-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Vaca:</label>
                            <input type="text" v-model="currentParicion.vaca" required class="form-input">
                        </div>
                        <div class="form-group">
                            <label>Arete (Tag):</label>
                            <input type="text" v-model="currentParicion.arete" placeholder="Número de arete" class="form-input">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Género:</label>
                            <select v-model="currentParicion.gender" class="form-select">
                                <option value="H">♀️ Hembra</option>
                                <option value="M">♂️ Macho</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Padre/Madre:</label>
                            <select v-model="currentParicion.parentId" class="form-select">
                                <option value="">Sin padre/madre</option>
                                <option v-for="animal in getAllAnimals()" :key="animal.id" :value="animal.id">
                                    {{ animal.vaca || animal.animal }} {{ animal.arete ? '(' + animal.arete + ')' : '' }}
                                </option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Fecha:</label>
                            <input type="text" v-model="currentParicion.fecha" placeholder="MM/YY o MM/DD/YYYY" class="form-input">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Cría Descripción:</label>
                        <textarea v-model="currentParicion.criaDescripcion" rows="3" class="form-textarea"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Foto:</label>
                        <input type="file" @change="handleParicionImage" accept="image/*" class="form-file">
                        <div v-if="currentParicion.image" class="image-preview">
                            <img :src="currentParicion.image" alt="Preview" class="preview-image">
                            <button type="button" @click="removeParicionImage" class="remove-image-btn">🗑️</button>
                        </div>
                    </div>
                    <button v-if="!editingParicion || paricionHasChanges" type="submit" class="btn-save">
                        {{ editingParicion ? '✅ Actualizar Parición' : '➕ Agregar Parición' }}
                    </button>
                </form>
            </div>
        </div>

        <!-- Add/Edit Ganado Modal -->
        <div v-if="showAddGanado" class="modal-overlay" @click.self="showAddGanado = false">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>{{ editingGanado ? '✏️ Editar' : '➕ Agregar' }} Ganado</h2>
                    <button @click="showAddGanado = false" class="modal-close">×</button>
                </div>
                <form @submit.prevent="addGanado" class="modal-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Animal:</label>
                            <input type="text" v-model="newGanado.animal" required class="form-input">
                        </div>
                        <div class="form-group">
                            <label>Arete (Tag):</label>
                            <input type="text" v-model="newGanado.arete" placeholder="Número de arete" class="form-input">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Tipo:</label>
                            <select v-model="newGanado.tipo" class="form-select">
                                <option value="V">🐄 Vaca</option>
                                <option value="T">🐂 Toro</option>
                                <option value="B">🐄 Becerra</option>
                                <option value="_B">🐂 Becerro</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Padre/Madre:</label>
                            <select v-model="newGanado.parentId" class="form-select">
                                <option value="">Sin padre/madre</option>
                                <option v-for="animal in getAllAnimals()" :key="animal.id" :value="animal.id">
                                    {{ animal.vaca || animal.animal }} {{ animal.arete ? '(' + animal.arete + ')' : '' }}
                                </option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Género:</label>
                            <select v-model="newGanado.gender" class="form-select">
                                <option value="H">♀️ Hembra</option>
                                <option value="M">♂️ Macho</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Estado:</label>
                            <select v-model="newGanado.muerto_vendido" class="form-select">
                                <option value="N">✅ Vivo</option>
                                <option value="S">💀 Muerto/Vendido</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Origen:</label>
                        <input type="text" v-model="newGanado.origen" class="form-input">
                    </div>
                    <div class="form-group">
                        <label>Comentarios:</label>
                        <textarea v-model="newGanado.comentarios" rows="2" class="form-textarea"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Fechas:</label>
                        <input type="text" v-model="newGanado.fechas" placeholder="Fechas importantes" class="form-input">
                    </div>
                    <button v-if="!editingGanado || ganadoHasChanges" type="submit" class="btn-save">
                        {{ editingGanado ? '✅ Actualizar Ganado' : '➕ Agregar Ganado' }}
                    </button>
                </form>
            </div>
        </div>

        <!-- Import Modals -->
        <div v-if="showSpreadsheetImport" class="modal-overlay" @click.self="showSpreadsheetImport = false">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>📋 Importar desde Hoja de Cálculo</h2>
                    <button @click="showSpreadsheetImport = false" class="modal-close">×</button>
                </div>
                <div class="import-content">
                    <p>Copia y pega los datos desde tu hoja de cálculo:</p>
                    <textarea v-model="spreadsheetData" rows="10" placeholder="Pega aquí los datos..." class="import-textarea"></textarea>
                    <div class="import-actions">
                        <button @click="parseSpreadsheetData" class="btn-primary">📊 Procesar Datos</button>
                    </div>
                    <div v-if="importPreview.length > 0" class="import-preview">
                        <h3>Vista Previa ({{ importPreview.length }} registros)</h3>
                        <div class="preview-table">
                            <table>
                                <thead>
                                    <tr><th>Vaca</th><th>Género</th><th>Fecha</th><th>Cría Descripción</th></tr>
                                </thead>
                                <tbody>
                                    <tr v-for="item in importPreview.slice(0, 5)" :key="item.id">
                                        <td>{{ item.vaca }}</td>
                                        <td>{{ item.gender }}</td>
                                        <td>{{ item.fecha }}</td>
                                        <td>{{ item.criaDescripcion }}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <button @click="processSpreadsheetData" class="btn-save">✅ Importar Datos</button>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="showCsvUpload" class="modal-overlay" @click.self="showCsvUpload = false">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>📄 Importar Archivo CSV</h2>
                    <button @click="showCsvUpload = false" class="modal-close">×</button>
                </div>
                <div class="import-content">
                    <input type="file" @change="handleCsvFile" accept=".csv" class="file-input">
                    <div v-if="csvPreview.length > 0" class="import-preview">
                        <h3>Vista Previa CSV</h3>
                        <button @click="processCsvData" class="btn-save">✅ Importar CSV</button>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="showGanadoImport" class="modal-overlay" @click.self="showGanadoImport = false">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>📋 Importar Datos de Ganado</h2>
                    <button @click="showGanadoImport = false" class="modal-close">×</button>
                </div>
                <div class="import-content">
                    <textarea v-model="ganadoData" rows="10" placeholder="Pega aquí los datos de ganado..." class="import-textarea"></textarea>
                    <button @click="parseGanadoData" class="btn-primary">📊 Procesar Datos</button>
                    <div v-if="ganadoPreview.length > 0" class="import-preview">
                        <h3>Vista Previa Ganado ({{ ganadoPreview.length }} registros)</h3>
                        
                        <!-- Duplicates Warning -->
                        <div v-if="ganadoDuplicates.length > 0" class="duplicates-warning">
                            <h4>⚠️ Duplicados Encontrados ({{ ganadoDuplicates.length }})</h4>
                            <p>Los siguientes registros ya existen y serán omitidos:</p>
                            <div class="duplicates-table">
                                <table>
                                    <thead>
                                        <tr>
                                            <th colspan="5">Nuevo Registro</th>
                                            <th colspan="5">Registro Existente</th>
                                        </tr>
                                        <tr>
                                            <th>Animal</th><th>Origen</th><th>Tipo</th><th>Fechas</th><th>Comentarios</th>
                                            <th>Animal</th><th>Origen</th><th>Tipo</th><th>Fechas</th><th>Comentarios</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-for="dup in ganadoDuplicates" :key="dup.new.id" class="duplicate-row">
                                            <td>{{ dup.new.animal }}</td>
                                            <td>{{ dup.new.origen }}</td>
                                            <td>{{ dup.new.tipo }}</td>
                                            <td>{{ dup.new.fechas || '-' }}</td>
                                            <td>{{ dup.new.comentarios || '-' }}</td>
                                            <td>{{ dup.existing.animal }}</td>
                                            <td>{{ dup.existing.origen }}</td>
                                            <td>{{ dup.existing.tipo }}</td>
                                            <td>{{ dup.existing.fechas || '-' }}</td>
                                            <td>{{ dup.existing.comentarios || '-' }}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- New Records Preview -->
                        <div v-if="ganadoPreview.length - ganadoDuplicates.length > 0">
                            <h4>✅ Registros Nuevos ({{ ganadoPreview.length - ganadoDuplicates.length }})</h4>
                            <div class="preview-table">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Animal</th>
                                            <th>Origen</th>
                                            <th>Comentarios</th>
                                            <th>Género</th>
                                            <th>Tipo</th>
                                            <th>Fechas</th>
                                            <th>Estado</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-for="item in ganadoPreview.filter(g => !ganadoDuplicates.some(d => d.new.animal === g.animal && d.new.origen === g.origen && d.new.tipo === g.tipo && d.new.fechas === g.fechas && d.new.comentarios === g.comentarios)).slice(0, 5)" :key="item.id">
                                            <td>{{ item.animal }}</td>
                                            <td>{{ item.origen || '-' }}</td>
                                            <td>{{ item.comentarios || '-' }}</td>
                                            <td>{{ item.gender }}</td>
                                            <td>{{ item.tipo }}</td>
                                            <td>{{ item.fechas || '-' }}</td>
                                            <td>{{ item.muerto_vendido === 'S' ? 'Muerto/Vendido' : 'Vivo' }}</td>
                                        </tr>
                                    </tbody>
                                </table>
                                <p v-if="ganadoPreview.length - ganadoDuplicates.length > 5" class="preview-note">
                                    Mostrando los primeros 5 de {{ ganadoPreview.length - ganadoDuplicates.length }} registros nuevos
                                </p>
                            </div>
                        </div>
                        
                        <div class="import-actions">
                            <button v-if="ganadoPreview.length - ganadoDuplicates.length > 0" @click="processGanadoData" class="btn-save">
                                ✅ Importar {{ ganadoPreview.length - ganadoDuplicates.length }} Registros Nuevos
                            </button>
                            <button v-else class="btn-secondary" disabled>
                                No hay registros nuevos para importar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Family Tree Modal -->
        <div v-if="showFamilyTree && selectedAnimal" class="modal-overlay" @click.self="showFamilyTree = false">
            <div class="modal-content family-tree-modal">
                <div class="modal-header">
                    <h2>🌳 Árbol Genealógico</h2>
                    <button @click="showFamilyTree = false" class="modal-close">×</button>
                </div>
                <div class="family-tree-content">
                    <div class="family-tree" v-if="selectedAnimal">
                        <!-- Grandparent -->
                        <div v-if="getFamilyTree(selectedAnimal).grandparent" class="family-level grandparent-level">
                            <h4>🏛️ Abuelo/a</h4>
                            <div class="family-member grandparent">
                                <div class="member-card">
                                    <div class="member-name">{{ getFamilyTree(selectedAnimal).grandparent.vaca || getFamilyTree(selectedAnimal).grandparent.animal }}</div>
                                    <div class="member-tag" v-if="getFamilyTree(selectedAnimal).grandparent.arete">Arete: {{ getFamilyTree(selectedAnimal).grandparent.arete }}</div>
                                    <div class="member-gender">{{ getFamilyTree(selectedAnimal).grandparent.gender === 'H' ? '♀️ Hembra' : '♂️ Macho' }}</div>
                                </div>
                            </div>
                        </div>

                        <!-- Parent -->
                        <div v-if="getFamilyTree(selectedAnimal).parent" class="family-level parent-level">
                            <h4>👨‍👩‍👧‍👦 Padre/Madre</h4>
                            <div class="family-member parent">
                                <div class="member-card">
                                    <div class="member-name">{{ getFamilyTree(selectedAnimal).parent.vaca || getFamilyTree(selectedAnimal).parent.animal }}</div>
                                    <div class="member-tag" v-if="getFamilyTree(selectedAnimal).parent.arete">Arete: {{ getFamilyTree(selectedAnimal).parent.arete }}</div>
                                    <div class="member-gender">{{ getFamilyTree(selectedAnimal).parent.gender === 'H' ? '♀️ Hembra' : '♂️ Macho' }}</div>
                                </div>
                            </div>
                        </div>

                        <!-- Current Animal -->
                        <div class="family-level current-level">
                            <h4>🎯 Animal Actual</h4>
                            <div class="family-member current">
                                <div class="member-card current-animal">
                                    <div class="member-name">{{ selectedAnimal.vaca || selectedAnimal.animal }}</div>
                                    <div class="member-tag" v-if="selectedAnimal.arete">Arete: {{ selectedAnimal.arete }}</div>
                                    <div class="member-gender">{{ selectedAnimal.gender === 'H' ? '♀️ Hembra' : '♂️ Macho' }}</div>
                                    <div class="member-date" v-if="selectedAnimal.fecha">Fecha: {{ selectedAnimal.fecha }}</div>
                                </div>
                            </div>
                        </div>

                        <!-- Children -->
                        <div v-if="getFamilyTree(selectedAnimal).children.length > 0" class="family-level children-level">
                            <h4>👶 Hijos ({{ getFamilyTree(selectedAnimal).children.length }})</h4>
                            <div class="family-members-grid">
                                <div v-for="child in getFamilyTree(selectedAnimal).children" :key="child.id" class="family-member child">
                                    <div class="member-card">
                                        <div class="member-name">{{ child.vaca || child.animal }}</div>
                                        <div class="member-tag" v-if="child.arete">Arete: {{ child.arete }}</div>
                                        <div class="member-gender">{{ child.gender === 'H' ? '♀️ Hembra' : '♂️ Macho' }}</div>
                                        <button @click="showFamilyTreeFor(child)" class="view-tree-btn">🌳</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Grandchildren -->
                        <div v-if="getFamilyTree(selectedAnimal).grandchildren.length > 0" class="family-level grandchildren-level">
                            <h4>👶👶 Nietos ({{ getFamilyTree(selectedAnimal).grandchildren.length }})</h4>
                            <div class="family-members-grid">
                                <div v-for="grandchild in getFamilyTree(selectedAnimal).grandchildren" :key="grandchild.id" class="family-member grandchild">
                                    <div class="member-card">
                                        <div class="member-name">{{ grandchild.vaca || grandchild.animal }}</div>
                                        <div class="member-tag" v-if="grandchild.arete">Arete: {{ grandchild.arete }}</div>
                                        <div class="member-gender">{{ grandchild.gender === 'H' ? '♀️ Hembra' : '♂️ Macho' }}</div>
                                        <button @click="showFamilyTreeFor(grandchild)" class="view-tree-btn">🌳</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Image Lightbox -->
        <div v-if="showImageLightbox" class="lightbox-overlay" @click="showImageLightbox = false">
            <div class="lightbox-content" @click.stop>
                <button @click="showImageLightbox = false" class="lightbox-close">×</button>
                <img :src="lightboxImage" alt="Imagen ampliada" class="lightbox-image">
            </div>
        </div>
        
        </div> <!-- End main-app -->
    </div>

    <script>
        // Debug AWS SDK loading
        console.log('Checking AWS SDK...');
        console.log('AWS available:', typeof AWS !== 'undefined');
        
        // Initialize AWS services
        let dynamodb = null;
        let s3 = null;
        let awsReady = false;
        
        function initAWS() {
            console.log('Attempting AWS init...');
            console.log('AWS object:', typeof AWS);
            
            if (typeof AWS !== 'undefined') {
                console.log('AWS.DynamoDB:', typeof AWS.DynamoDB);
                console.log('AWS.S3:', typeof AWS.S3);
                
                try {
                    // Load environment variables from Vercel
                    const envResponse = await fetch('/js/env.js');
                    const envScript = await envResponse.text();
                    eval(envScript);
                    
                    if (!window.ENV || !window.ENV.accessKeyId || !window.ENV.secretAccessKey) {
                        throw new Error('AWS credentials not available');
                    }
                    
                    AWS.config.update({
                        region: 'us-east-1',
                        accessKeyId: window.ENV.accessKeyId,
                        secretAccessKey: window.ENV.secretAccessKey
                    });
                    
                    dynamodb = new AWS.DynamoDB.DocumentClient();
                    s3 = new AWS.S3();
                    awsReady = true;
                    console.log('✅ AWS services initialized successfully');
                    return true;
                } catch (error) {
                    console.error('❌ AWS initialization failed:', error);
                    return false;
                }
            } else {
                console.log('❌ AWS SDK not loaded');
                return false;
            }
        }
        
        // Try multiple times to initialize
        let initAttempts = 0;
        function tryInit() {
            initAttempts++;
            console.log(`Init attempt ${initAttempts}`);
            
            if (initAWS()) {
                console.log('✅ AWS services ready!');
                return;
            }
            
            if (initAttempts < 5) {
                setTimeout(tryInit, 1000);
            } else {
                console.warn('⚠️ Giving up on AWS SDK, using localStorage only');
            }
        }
        
        // Start trying immediately and after page load
        tryInit();
        window.addEventListener('load', tryInit);

        // Clear localStorage to free up space (data is safe in DynamoDB)
        window.clearLocalStorage = function() {
            if (!awsReady) {
                alert('Cannot clear localStorage - DynamoDB not available as backup!');
                return;
            }
            
            if (confirm('Clear local storage? (Data will remain safe in cloud)')) {
                const keys = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && key.startsWith('cattle_')) {
                        keys.push(key);
                    }
                }
                
                keys.forEach(key => localStorage.removeItem(key));
                console.log(`🧹 Cleared ${keys.length} items from localStorage`);
                alert(`Cleared ${keys.length} items from local storage. Data remains safe in cloud.`);
            }
        };

        // Migration function to sync localStorage to DynamoDB
        window.migrateToCloud = async function() {
            if (!awsReady) {
                alert('DynamoDB not available');
                return;
            }
            
            console.log('🔄 Starting migration to DynamoDB...');
            let migrated = 0;
            
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('cattle_')) {
                    try {
                        const data = localStorage.getItem(key);
                        const parsedData = JSON.parse(data);
                        
                        await dynamodb.put({
                            TableName: 'CattleData',
                            Item: {
                                id: key,
                                data: parsedData,
                                timestamp: Date.now()
                            }
                        }).promise();
                        
                        migrated++;
                        console.log('✅ Migrated:', key);
                    } catch (error) {
                        console.error('❌ Migration failed for:', key, error);
                    }
                }
            }
            
            console.log(`🎉 Migration complete! ${migrated} items synced to DynamoDB`);
            alert(`Migration complete! ${migrated} items synced to cloud.`);
        };

        // Database with DynamoDB + localStorage
        // S3 image storage functions
        const BUCKET_NAME = 'cattle-tracker-images-2025';
        
        async function uploadImageToS3(imageData, fileName) {
            if (!awsReady || !s3) {
                throw new Error('S3 not available');
            }
            
            // Convert base64 to blob
            const base64Data = imageData.replace(/^data:image\/\w+;base64,/, '');
            const buffer = Uint8Array.from(atob(base64Data), c => c.charCodeAt(0));
            
            const params = {
                Bucket: BUCKET_NAME,
                Key: fileName,
                Body: buffer,
                ContentType: 'image/jpeg',
                ACL: 'private'
            };
            
            const result = await s3.upload(params).promise();
            console.log('✅ Image uploaded to S3:', fileName);
            return result.Location;
        }
        
        async function getImageFromS3(fileName) {
            if (!awsReady || !s3) {
                return null;
            }
            
            try {
                const params = {
                    Bucket: BUCKET_NAME,
                    Key: fileName,
                    Expires: 3600 // 1 hour signed URL
                };
                
                const url = s3.getSignedUrl('getObject', params);
                console.log('✅ Generated S3 signed URL:', fileName);
                return url;
            } catch (error) {
                console.error('❌ Failed to get S3 image:', error);
                return null;
            }
        }
        
        async function deleteImageFromS3(fileName) {
            if (!awsReady || !s3) {
                return;
            }
            
            try {
                const params = {
                    Bucket: BUCKET_NAME,
                    Key: fileName
                };
                
                await s3.deleteObject(params).promise();
                console.log('✅ Image deleted from S3:', fileName);
            } catch (error) {
                console.error('❌ Failed to delete S3 image:', error);
            }
        }

        // Helper function to process images for S3 storage
        async function processImagesForS3(data) {
            if (!Array.isArray(data)) return data;
            
            const processedData = [];
            
            for (const item of data) {
                const processedItem = { ...item };
                
                if (item.image && item.image.startsWith('data:image/')) {
                    try {
                        // Generate unique filename
                        const fileName = `cattle_${item.id || Date.now()}_${Math.random().toString(36).substr(2, 9)}.jpg`;
                        
                        // Upload to S3
                        const s3Url = await uploadImageToS3(item.image, fileName);
                        
                        // Replace base64 with S3 reference
                        processedItem.image = null; // Remove base64
                        processedItem.imageS3 = fileName; // Store S3 key
                        processedItem.imageUrl = s3Url; // Store S3 URL for immediate use
                        
                        console.log('📸 Moved image to S3:', fileName);
                    } catch (error) {
                        console.warn('⚠️ S3 upload failed, keeping base64:', error);
                        // Keep original base64 as fallback
                    }
                }
                
                processedData.push(processedItem);
            }
            
            return processedData;
        }
        
        // Helper function to load images from S3
        async function loadImagesFromS3(data) {
            if (!Array.isArray(data)) return data;
            
            const loadedData = [];
            
            for (const item of data) {
                const loadedItem = { ...item };
                
                if (item.imageS3 && !item.image) {
                    try {
                        // Get signed URL for display
                        const signedUrl = await getImageFromS3(item.imageS3);
                        if (signedUrl) {
                            loadedItem.imageUrl = signedUrl;
                        }
                    } catch (error) {
                        console.warn('⚠️ Failed to load S3 image:', error);
                    }
                }
                
                loadedData.push(loadedItem);
            }
            
            return loadedData;
        }
        function compressImage(base64, maxSize = 50000) {
            if (!base64 || !base64.startsWith('data:image/')) return base64;
            
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // Calculate new dimensions (max 800px)
                    let { width, height } = this;
                    const maxDim = 800;
                    if (width > maxDim || height > maxDim) {
                        if (width > height) {
                            height = (height * maxDim) / width;
                            width = maxDim;
                        } else {
                            width = (width * maxDim) / height;
                            height = maxDim;
                        }
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(this, 0, 0, width, height);
                    
                    // Compress with quality adjustment
                    let quality = 0.7;
                    let compressed = canvas.toDataURL('image/jpeg', quality);
                    
                    // Reduce quality if still too large
                    while (compressed.length > maxSize && quality > 0.1) {
                        quality -= 0.1;
                        compressed = canvas.toDataURL('image/jpeg', quality);
                    }
                    
                    resolve(compressed);
                };
                img.src = base64;
            });
        }

        // Helper function to split large arrays
        function splitLargeData(key, data) {
            const dataStr = JSON.stringify(data);
            const maxSize = 300000; // 300KB limit for safety
            
            if (dataStr.length <= maxSize) {
                return [{ key, data }];
            }
            
            // Split array into chunks
            const chunks = [];
            const chunkSize = Math.ceil(data.length / Math.ceil(dataStr.length / maxSize));
            
            for (let i = 0; i < data.length; i += chunkSize) {
                chunks.push({
                    key: `${key}_chunk_${Math.floor(i / chunkSize)}`,
                    data: data.slice(i, i + chunkSize)
                });
            }
            
            // Add metadata chunk
            chunks.push({
                key: `${key}_meta`,
                data: {
                    isChunked: true,
                    totalChunks: chunks.length - 1,
                    originalKey: key
                }
            });
            
            return chunks;
        }

        const db = {
            async save(key, data) {
                // Process images for S3 storage
                let processedData = data;
                if (awsReady && s3) {
                    try {
                        processedData = await processImagesForS3(data);
                    } catch (error) {
                        console.warn('⚠️ S3 processing failed, using original data:', error);
                    }
                }
                
                if (awsReady && dynamodb) {
                    try {
                        await dynamodb.put({
                            TableName: 'CattleData',
                            Item: {
                                id: key,
                                data: processedData,
                                timestamp: Date.now()
                            }
                        }).promise();
                        console.log('✅ Saved to DynamoDB:', key);
                        
                        // Save small items to localStorage as backup
                        try {
                            const dataStr = JSON.stringify(processedData);
                            if (dataStr.length < 50000) {
                                localStorage.setItem(key, dataStr);
                            }
                        } catch (quotaError) {
                            console.warn('⚠️ localStorage full, DynamoDB only:', key);
                        }
                        return;
                    } catch (error) {
                        console.error('❌ DynamoDB save failed:', error);
                    }
                }
                
                // Fallback to localStorage
                try {
                    localStorage.setItem(key, JSON.stringify(data));
                    console.log('💾 Saved to localStorage:', key);
                } catch (quotaError) {
                    console.error('❌ Storage quota exceeded:', key);
                    alert('Storage full! Data may not be saved properly.');
                }
            },
            
            async load(key) {
                if (awsReady && dynamodb) {
                    try {
                        const result = await dynamodb.get({
                            TableName: 'CattleData',
                            Key: { id: key }
                        }).promise();
                        
                        if (result.Item) {
                            console.log('✅ Loaded from DynamoDB:', key);
                            
                            // Load S3 images if available
                            const dataWithImages = await loadImagesFromS3(result.Item.data);
                            return dataWithImages;
                        }
                    } catch (error) {
                        console.error('❌ DynamoDB load failed:', error);
                    }
                }
                
                // Fallback to localStorage
                const data = localStorage.getItem(key);
                if (!data) return null;
                
                try {
                    console.log('📂 Loaded from localStorage:', key);
                    return JSON.parse(data);
                } catch (error) {
                    return data;
                }
            },
            
            async delete(key) {
                if (awsReady && dynamodb) {
                    try {
                        await dynamodb.delete({
                            TableName: 'CattleData',
                            Key: { id: key }
                        }).promise();
                        console.log('✅ Deleted from DynamoDB:', key);
                    } catch (error) {
                        console.error('❌ DynamoDB delete failed:', error);
                    }
                }
                
                localStorage.removeItem(key);
                console.log('🗑️ Deleted from localStorage:', key);
            }
        };
    </script>
    <script src="app.js"></script>
</body>
</html>
